<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>Paradigm30</title>
    <base href="../" />
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css"
        integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU" crossorigin="anonymous">
    <!--link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css"-->
    <link rel="stylesheet" href="css/chess_p30.css">
    <link rel="icon" type="image/png" href="favicon.png">
    <script src='//cdnjs.cloudflare.com/ajax/libs/moment.js/2.7.0/moment.min.js'></script>
    <link rel='stylesheet' href='//cdn.jsdelivr.net/flat-ui/2.0/css/flat-ui.css'>
</head>

<body>
    <div class="header">Paradigm Chess30</div>
    <div class="main-container"> 
    <div id="boardPanel">
        <div id="myBoard"></div>
        <div class="panel">
            <div id="status"></div>
        </div>
    <div class="right-panel">
        <div class="panel">
            <div id="fen"></div>
        </div>
        <div class="panel">
            <div id="pgn" class='scroll'></div>
        </div>
    </div>
        <div id="promotion-popup">
            <form title="Promotion" id="promotionForm">
                <fieldset>
                    <span class="promotion_title"></span>Promote:</span><br>
                    <label>
                        <input type="radio" id="q" name="promo" value="q" checked>
                        <img src="img/chesspieces/wikipedia/wQ.png" width="50px">
                    </label>
                    <label>
                        <input type="radio" id="b" name="promo" value="b">

                        <img src="img/chesspieces/wikipedia/wB.png">
                    </label>
                    <label>
                        <input type="radio" id="r" name="promo" value="r">
                        <img src="img/chesspieces/wikipedia/wR.png">
                    </label>
                    <label>
                        <input type="radio" id="n" name="promo" value="n">
                        <img src="img/chesspieces/wikipedia/wN.png">
                    </label>
                </fieldset>
                <br>
                <input type="button" class="close-promotion" id="close-promotion" value="OK" centered
                    onclick="$('#promotion-popup').style.display=none">
            </form>
        </div>
    </div>
</div>
    <!--- End HTML -------------------------------------------------------->

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <!--script src="js/chessboard.js"></script-->
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"
        integrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3QbPyX8kWyb93+8AC/pPWTzj+nHtbC5bxD"
        crossorigin="anonymous"></script>
    <script src="js/chess_p30.js"></script>
    <!-- NOTE: chess_p30 is based on the chess.js library:
         https://github.com/jhlywa/chess.js -->
    <script>
        // --- Begin p30 JS --------------------------------------------------------

        var board = null
        var game = new Chess()
        var $status = $('#status')
        var $fen = $('#fen')
        var $pgn = $('#pgn')
        var $promotion = $('#promotion-popup')
        var $close_promotion_btn = $('close-promotion')


        function onDragStart(source, piece, position, orientation) {
            // do not pick up pieces if the game is over
            if (game.game_over()) return false

            // only pick up pieces for the side to move
            if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                return false
            }
        }

        function choose_promotion(color) {
            // TODO: show icons of correct colour
            $promotion.show()
        }

        var promotion_piece = 'q'

        $close_promotion_btn.onclick = function () {
            promotion_piece = $('input[name=promo]:checked', '#promotionForm')
            $promotion.hide()
        }

        function promoting(source, target, turn) {
            /** If pawn is promoting, returns user's selection of promotion piece,
             * else null */
            var from = board.position()[source]
            var result = null;
            if ((from === 'wP') && (target[1] === '8')) {
                // WP -> 8th rank 
                choose_promotion('w')
                result = promotion_piece
            }
            else if ((from === 'bP') && (target[1] === '1')) {
                // BP -> 1st rank
                choose_promotion('b')
                result = promotion_piece
            }
            promotion_piece = 'q' // Return PP to its default value
            return result;
        }

        function onDrop(source, target) {
            // Allow choice of promotion if appropriate
            promotion = promoting(source, target, game.turn())
            // see if the move is legal
            var move = game.move({
                from: source,
                to: target,
                promotion: promotion
            })

            // illegal move
            if (move === null) return 'snapback'

            updateStatus()
        }

        // update the board position after the piece snap
        // for castling, en passant, pawn promotion
        function onSnapEnd() {
            board.position(game.fen())
        }

        function updateStatus() {
            var status = ''

            var moveColor = 'White'
            if (game.turn() === 'b') {
                moveColor = 'Black'
            }

            // checkmate?
            if (game.in_checkmate()) {
                status = 'Game over, ' + moveColor + ' is checkmated!.'
            }

            // draw?
            else if (game.in_draw()) {
                status = 'Game over, drawn position!'
            }

            // game still on
            else {
                status = moveColor + ' to move'

                // check?
                if (game.in_check()) {
                    status += ' - ' + 'check!'
                }
            }
            $status.html(status)
            $fen.html(game.fen())
            $pgn.html(game.pgn())
        }

        var config = {
            //pieceTheme: 'img/chesspieces/uscf/{piece}.png',
            draggable: true,
            //position: 'start',
            onDragStart: onDragStart,
            onDrop: onDrop,
            onSnapEnd: onSnapEnd
        };

        $(window).on("load", function () {
            board = Chessboard('myBoard', config)
            board.position(game.fen())
            updateStatus()
        });

        var $promotion_popup = $("#promotion-popup").dialog({
            autoOpen: false,
            height: 400,
            width: 350,
            modal: true,
            buttons: {
                text: "Promote", click: function () {
                    promotion_piece = $('input[name=promo]:checked').val(),
                        $promotion_popup.dialog.dialog("close");
                }
            }
        });

    </script>

</body>

</html>